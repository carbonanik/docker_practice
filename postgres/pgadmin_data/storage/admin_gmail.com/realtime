-- PostgresSQL UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create todos table
CREATE TABLE todos (
    id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
    created_time TIMESTAMPTZ NOT NULL DEFAULT now(),
    title VARCHAR(512) NOT NULL,
    completed BOOLEAN NOT NULL
)

-- Insert data
INSERT INTO todos (title, completed) VALUES ('Todo 1', true), ('Todo 2', false);

-- Postgres Has json support
SELECT row_to_json(todos) FROM todos;

-- Create function
CREATE OR REPLACE FUNCTION todos_notify_func() RETURNS TRIGGER AS $$
BEGIN
    PERFORM pg_notify('todos_update'::text, row_to_json(NEW)::text);
    RETURN NEW;
END
$$ LANGUAGE plpgsql

-- Create trigger
CREATE OR REPLACE TRIGGER todos_notify_trig 
AFTER INSERT OR UPDATE OR DELETE ON todos
FOR EACH ROW EXECUTE PROCEDURE todos_notify_func();


-- Listen for events
LISTEN todos_update;